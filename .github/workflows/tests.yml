name: tests

on:
  pull_request:
  push:
    branches:
      - master
  schedule:
    - cron: '0 0 * * *'

jobs:

  tests:
    runs-on: ubuntu-20.04
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true
    - name: Prepare environment
      run: |
        set -eux
        cd ..

        # install qemu
        sudo apt-get install -y qemu-system

        # prepare disk image
        sudo modprobe nbd
        qemu-img create -f qcow2 archlinux.qcow2 10.01G
        sudo qemu-nbd --connect=/dev/nbd0 archlinux.qcow2
        sudo parted /dev/nbd0 -s mklabel gpt mkpart ext4 2048s 10GiB print
        sudo mkfs.ext4 /dev/nbd0p1
        sudo mount /dev/nbd0p1 /mnt
        sudo docker run --privileged -v /mnt:/newroot archlinux bash -c 'pacman -Sy --noconfirm arch-install-scripts && pacstrap /newroot base base-devel linux linux-firmware python python-pip python-pytest xonsh'
        
        # copy files
        wait
        cp /mnt/boot/vmlinuz-linux .
        pwd
        ls
        sudo cp tcg /mnt
        sudo chown root:root /mnt/tcg
        sudo chroot /mnt ls

        sudo umount /mnt
        sudo qemu-nbd --disconnect /dev/nbd0

        qemu-system-x86_64 -kernel vmlinuz-linux -initrd initramfs-linux.img -hda archlinux.qcow2 -append "console=ttyS0 root=/dev/sda" -monitor vc -serial stdio -nographic